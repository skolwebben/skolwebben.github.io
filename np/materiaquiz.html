<!DOCTYPE html>
<html lang="sv">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Fysikquiz: Materia & Värme (Åk 9)</title>
   <!-- Importerar moderna fonter från Google Fonts -->
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Poppins:wght@500;700&display=swap" rel="stylesheet">
  
   <style>
       :root {
           /* Färgpalett - Professionell & Ren */
           --card-bg: #ffffff;
          
           --brand-color: #2c3e50;
           --brand-gradient: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
          
           --accent-color: #3498db;
          
           --success-color: #10ac84;
           --success-bg: #e3f9f1;
          
           --error-color: #ee5253;
           --error-bg: #ffeded;
          
           --text-main: #2d3436;
           --text-muted: #636e72;
          
           --shadow-card: 0 10px 25px rgba(0,0,0,0.15);
           --shadow-hover: 0 6px 16px rgba(0,0,0,0.12);
           --radius-main: 16px;
       }


       body {
           font-family: 'Open Sans', sans-serif;
           /* Gråaktig fade (Silver/Metallic style) */
           background-image: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
           color: var(--text-main);
           margin: 0;
           padding: 15px;
           display: flex;
           justify-content: center;
           align-items: flex-start;
           min-height: 100vh;
       }


       .container {
           background-color: var(--card-bg);
           width: 100%;
           max-width: 680px;
           border-radius: var(--radius-main);
           box-shadow: var(--shadow-card);
           overflow: hidden;
           display: flex;
           flex-direction: column;
           position: relative;
           margin-top: 3vh;
           margin-bottom: 3vh;
       }


       header {
           background: var(--brand-gradient);
           color: white;
           padding: 20px;
           text-align: center;
           position: relative;
           overflow: hidden;
       }


       h1 {
           font-family: 'Poppins', sans-serif;
           margin: 0;
           font-size: 1.5rem;
           font-weight: 700;
           letter-spacing: -0.3px;
       }


       .content-area {
           padding: 25px 30px;
           flex-grow: 1;
       }


       h2 {
           font-family: 'Poppins', sans-serif;
           color: var(--brand-color);
           margin-top: 0;
           font-size: 1.3rem;
           margin-bottom: 0.8rem;
           line-height: 1.3;
       }


       /* Fact Section Styles */
       .fact-box {
           background: #f8f9fa;
           border-radius: 12px;
           padding: 20px;
           margin-bottom: 20px;
           /* Ingen border-left */
           display: flex;
           gap: 15px;
           align-items: flex-start;
       }
      
       .fact-icon {
           font-size: 2rem;
           display: block;
           margin-top: -5px;
       }
      
       .fact-content {
           flex: 1;
       }


       .btn {
           background: var(--brand-gradient);
           color: white;
           border: none;
           padding: 12px 24px;
           font-family: 'Poppins', sans-serif;
           font-size: 1rem;
           font-weight: 600;
           border-radius: 8px;
           cursor: pointer;
           transition: all 0.2s ease;
           display: block;
           width: 100%;
           margin-top: 20px;
           box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2);
       }


       .btn:hover {
           transform: translateY(-2px);
           box-shadow: 0 6px 14px rgba(52, 152, 219, 0.3);
           opacity: 0.95;
       }


       /* Question Styles */
       .question-meta {
           display: inline-block;
           color: var(--text-muted);
           font-size: 0.85rem;
           margin-bottom: 10px;
           font-weight: 600;
           text-transform: uppercase;
           letter-spacing: 0.5px;
       }


       .options-grid {
           display: grid;
           gap: 12px;
           margin-top: 20px;
       }


       .option-btn {
           background-color: #fff;
           border: 2px solid #f1f2f6;
           padding: 15px 20px;
           text-align: left;
           border-radius: 10px;
           cursor: pointer;
           font-family: 'Open Sans', sans-serif;
           font-size: 0.95rem;
           font-weight: 500;
           transition: all 0.15s ease;
           color: var(--text-main);
           position: relative;
       }


       .option-btn:hover:not(:disabled) {
           border-color: var(--accent-color);
           background-color: #f8fcff;
           transform: translateX(3px);
           box-shadow: 0 2px 5px rgba(0,0,0,0.05);
       }
      
       /* Status states for options */
       .option-btn.correct {
           background-color: var(--success-bg);
           border-color: var(--success-color);
           color: #0b6e4f;
           font-weight: 600;
       }
      
       .option-btn.correct::after {
           content: "✓";
           position: absolute;
           right: 15px;
           font-weight: bold;
       }


       .option-btn.incorrect {
           background-color: var(--error-bg);
           border-color: var(--error-color);
           color: #c0392b;
           opacity: 0.8;
       }


       .option-btn:disabled {
           cursor: default;
       }


       /* Feedback Box */
       .feedback-box {
           margin-top: 20px;
           padding: 20px 25px;
           border-radius: 12px;
           background-color: #f8f9fa;
           color: var(--text-main);
           border: 1px solid #e9ecef;
           display: none;
           animation: fadeIn 0.3s ease;
       }
      
       .feedback-box h3 {
           margin-top: 0;
           font-family: 'Poppins', sans-serif;
           font-size: 1.2rem;
           display: flex;
           align-items: center;
           gap: 8px;
           margin-bottom: 8px;
       }


       .feedback-box.success h3 {
           color: var(--success-color);
       }
      
       .feedback-box.error h3 {
           color: var(--error-color);
       }


       .feedback-box strong {
           color: var(--brand-color);
       }


       @keyframes fadeIn {
           from { opacity: 0; transform: translateY(5px); }
           to { opacity: 1; transform: translateY(0); }
       }


       /* Progress Bar Styles */
       .progress-bar-container {
           height: 6px;
           background-color: #f1f3f5;
           width: 100%;
           position: relative;
           z-index: 10;
       }


       .progress-bar {
           height: 100%;
           background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
           width: 0%;
           transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
           border-radius: 0 4px 4px 0;
           box-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
       }


       /* Summary Styles */
       .summary-stats {
           text-align: center;
           background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
           border: 1px solid #dee2e6;
           padding: 30px 20px;
           border-radius: 12px;
           margin-bottom: 20px;
       }


       .summary-score {
           font-size: 3.5rem;
           font-family: 'Poppins', sans-serif;
           font-weight: 700;
           display: block;
           margin: 5px 0;
           line-height: 1;
           background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
           -webkit-background-clip: text;
           -webkit-text-fill-color: transparent;
       }
      
       .summary-list {
           max-height: 400px;
           overflow-y: auto;
           padding-right: 10px;
       }
      
       .summary-item {
           background: white;
           border-bottom: 1px solid #f1f1f1;
           padding: 12px 0;
       }
      
       .summary-item:last-child {
           border-bottom: none;
       }


       .summary-question {
           font-weight: 600;
           margin-bottom: 4px;
           display: block;
           font-size: 0.95rem;
       }
      
       .summary-answer-row {
           font-size: 0.9rem;
       }


       .summary-correct-text { color: var(--success-color); font-weight: 600; }
       .summary-wrong-text { color: var(--error-color); text-decoration: line-through; opacity: 0.8;}
       .real-answer { color: var(--success-color); font-weight: 600; margin-left: 5px; }


       /* Helpers */
       strong {
           color: var(--brand-color);
           font-weight: 700;
       }


   </style>
</head>
<body>


<div class="container">
   <header>
       <h1 id="header-title">Fysikquiz: Materia & Värme</h1>
   </header>
   <div class="progress-bar-container">
       <div class="progress-bar" id="progress-bar"></div>
   </div>


   <div class="content-area" id="app">
       <!-- Content will be injected here by JavaScript -->
   </div>
</div>


<script>
   // --- DATA ---
   const quizData = [
       {
           title: "Tema 1: Partikelmodellen & Värme",
           icon: "⚛️",
           text: "Allt omkring oss är uppbyggt av atomer, som är naturens byggstenar. Materia är allt som har en massa (vikt). Enligt <strong>partikelmodellen</strong> rör sig dessa små partiklar ständigt. Värme är ett mått på hur mycket partiklarna rör sig; ju högre temperaturen är, desto snabbare rör sig atomerna. När materia värms upp tar partiklarna mer plats eftersom de knuffar på varandra mer, vilket kallas för <strong>värmeutvidgning</strong>.",
           questions: [
               {
                   q: "En rispapperslykta fylld med varm luft stiger uppåt. Vilket påstående förklarar bäst varför?",
                   options: [
                       "Partiklarna i den varma luften krockar mindre, vilket minskar friktionen.",
                       "Varm luft har högre densitet och trycker sig därför uppåt genom atmosfären.",
                       "Varm luft har lägre densitet än kall luft, vilket skapar en lyftkraft uppåt.", // Rätt (Index 2)
                       "Tyngdkraften påverkar inte gaser som har en temperatur över 50 grader."
                   ],
                   correct: 2,
                   explanation: "När luften i lyktan värms upp rör sig partiklarna snabbare och sprider ut sig mer. Detta gör att luften blir <strong>glesare</strong> (lägre densitet) än den kalla luften utanför, vilket får lyktan att stiga likt en kork i vatten."
               },
               {
                   q: "Om du tar ut en tom, stängd PET-flaska i kylan en vinterdag skrynklas den ihop. Vad är orsaken?",
                   options: [
                       "Luftpartiklarna rör sig långsammare och tar mindre plats, vilket minskar volymen.", // Rätt (Index 0)
                       "Kylan gör att plasten i flaskan reagerar kemiskt och drar ihop sig.",
                       "Det yttre lufttrycket ökar kraftigt vid låga temperaturer och krossar flaskan.",
                       "Luftpartiklarna kondenserar till vatten och rinner ut genom korken."
                   ],
                   correct: 0,
                   explanation: "När temperaturen sjunker minskar atomernas rörelseenergi inne i flaskan. De 'knuffas' mindre mot väggarna och kommer närmare varandra, vilket gör att gasens totala <strong>volym minskar</strong> och flaskan dras samman av det yttre trycket."
               },
               {
                   q: "Vad händer med en järnvägsräls av stål en mycket varm sommardag?",
                   options: [
                       "Skenornas massa ökar eftersom värmeenergi har vikt.",
                       "Skenornas densitet ökar kraftigt på grund av solljuset.",
                       "Skenorna blir kortare då värmen får metallen att dunsta.",
                       "Skenornas volym ökar eftersom atomerna vibrerar kraftigare." // Rätt (Index 3)
                   ],
                   correct: 3,
                   explanation: "Vid uppvärmning vibrerar metallatomerna mer våldsamt och kräver större utrymme kring sina jämviktslägen. Detta leder till <strong>värmeutvidgning</strong> där rälsen blir både längre och bredare, vilket kan orsaka solkurvor om det inte finns expansionsfogar."
               }
           ]
       },
       {
           title: "Tema 2: Fasövergångar",
           icon: "💧",
           text: "De flesta ämnen kan förekomma i tre olika faser: <strong>fast</strong>, <strong>flytande</strong> och <strong>gas</strong>. Vilken fas ett ämne befinner sig i styrs av temperaturen och partiklarnas rörelse. När ett ämne byter fas kallas det för en <strong>fasövergång</strong>. Exempelvis kallas det <strong>kondensation</strong> när en gas blir vätska, och <strong>avdunstning</strong> när en vätska blir gas.",
           questions: [
               {
                   q: "Efter att du duschat varmt kan det bildas vattendroppar på en kall spegel i badrummet. Vad kallas detta fenomen?",
                   options: [
                       "Sublimering, då ångan övergår direkt till fast form.",
                       "Kondensation, då vattenångan kyls ner och blir flytande.", // Rätt (Index 1)
                       "Avdunstning, då ytspänningen drar ihop fukten.",
                       "Transpiration, då spegeln avger fukt på grund av värmen."
                   ],
                   correct: 1,
                   explanation: "När den varma vattenångan träffar den kalla spegelytan förlorar vattenmolekylerna energi. De bromsas in och binds till varandra igen, vilket innebär att de övergår från <strong>gasform till flytande form</strong>."
               },
               {
                   q: "Varför torkar en blöt tröja snabbare i solen än i skuggan?",
                   options: [
                       "Solen sänker lufttrycket runt tröjan, vilket suger ut vattnet.",
                       "UV-strålningen bryter sönder vattenmolekylerna till syre och väte.",
                       "Solen tillför energi som får vattenmolekylerna att röra sig snabbare.", // Rätt (Index 2)
                       "Vattnet absorberas av solljusets fotoner och försvinner."
                   ],
                   correct: 2,
                   explanation: "För att vatten ska avdunsta krävs energi för att bryta bindningarna mellan molekylerna. Solens värme ger vattenmolekylerna högre <strong>rörelseenergi</strong>, vilket gör att fler molekyler orkar lämna tyget och bli vattenånga."
               },
               {
                   q: "Vilket ämne är bäst för en utetermometer i Sverige? (Pentan: kokpunkt 36°C, Etanol: fryspunkt -114°C, Glykol: trögflytande)",
                   options: [
                       "Pentan, eftersom låg kokpunkt ger snabbare reaktionstid.",
                       "Vatten, eftersom det är mest miljövänligt vid läckage.",
                       "Kvicksilver, eftersom det reagerar snabbast på värme.",
                       "Etanol, eftersom fryspunkten är låg nog för kalla vintrar." // Rätt (Index 3)
                   ],
                   correct: 3,
                   explanation: "En termometervätska får inte frysa när det är kallt eller koka när det är varmt. Etanol har en mycket låg <strong>fryspunkt (-114°C)</strong> vilket gör att den fungerar utmärkt även under de kallaste svenska vinterdagarna."
               }
           ]
       },
       {
           title: "Tema 3: Densitet & Arkimedes princip",
           icon: "🚤",
           text: "<strong>Densitet</strong> beskriver hur tätt partiklarna i ett ämne är packade (massa per volym). Ett ämne med låg densitet är 'lättare' än ett ämne med hög densitet om de har samma volym. <strong>Arkimedes princip</strong> säger att ett föremål som sänks ner i en vätska påverkas av en <strong>lyftkraft</strong> som är lika stor som tyngden av den vätska som trängs undan.",
           questions: [
               {
                   q: "Ett lastfartyg flyter högre upp vid vattenlinjen i saltvatten än i sötvatten. Vad är den fysikaliska förklaringen?",
                   options: [
                       "Saltvatten har högre densitet än sötvatten, vilket ger en kraftigare lyftkraft.", // Rätt (Index 0)
                       "Ytspänningen är starkare i saltvatten och håller fartyget uppe.",
                       "Saltkristallerna skapar friktion mot skrovet som bromsar sjunkandet.",
                       "Sötvatten tränger lättare in i skrovet och gör fartyget tyngre."
                   ],
                   correct: 0,
                   explanation: "Saltet gör att vattnet väger mer per liter (högre densitet). Enligt <strong>Arkimedes princip</strong> bestäms lyftkraften av tyngden på det undanträngda vattnet; eftersom saltvatten är tyngre krävs det mindre undanträngd volym för att bära fartyget."
               },
               {
                   q: "Is flyter på vatten, vilket är ovanligt för fasta ämnen. Vad innebär detta för isens egenskaper?",
                   options: [
                       "Isen innehåller luftbubblor som lyfter den mot ytan.",
                       "Is har lägre densitet än flytande vatten på grund av kristallstrukturen.", // Rätt (Index 1)
                       "Isen är egentligen tyngre men hålls uppe av ytspänningen.",
                       "Isen saknar massa eftersom molekylerna står stilla."
                   ],
                   correct: 1,
                   explanation: "När vatten fryser ordnar sig molekylerna i ett glesare mönster än i vätskeform. Detta gör att isen får <strong>lägre densitet</strong> än det flytande vattnet, vilket är anledningen till att isberg flyter och sjöar fryser uppifrån och ner."
               },
               {
                   q: "En sten väger 50 N. Du sänker ner den i vatten och den tränger undan vatten som väger 20 N. Vad visar dynamometern när stenen är i vattnet?",
                   options: [
                       "70 N, eftersom vattentrycket adderas till vikten.",
                       "50 N, eftersom stenens massa inte ändras av vatten.",
                       "30 N, eftersom lyftkraften minskar den upplevda tyngden.", // Rätt (Index 2)
                       "20 N, eftersom stenen antar vattnets vikt."
                   ],
                   correct: 2,
                   explanation: "Lyftkraften är riktad uppåt och är lika stor som tyngden av det undanträngda vattnet (20 N). Den resulterande kraften blir då stenens tyngd minus lyftkraften: <strong>50 N - 20 N = 30 N</strong>."
               }
           ]
       },
       {
           title: "Tema 4: Tryck i luft och vatten",
           icon: "🎈",
           text: "<strong>Tryck</strong> definieras som kraft fördelad på en yta. Ju mindre ytan är, desto högre blir trycket om kraften är densamma. <strong>Lufttrycket</strong> beror på tyngden av alla luftmolekyler ovanför oss och minskar ju högre upp vi kommer. <strong>Kommunicerande kärl</strong> innebär att vattenytan i sammanhängande kärl alltid hamnar på samma nivå.",
           questions: [
               {
                   q: "Varför sväller en oöppnad chipspåse upp om man tar med den högt upp på ett berg?",
                   options: [
                       "Kylan på berget får plasten att slappna av och expandera.",
                       "Luften inuti påsen expanderar på grund av ökad solstrålning.",
                       "Luftmolekyler tränger in genom påsens porer på hög höjd.",
                       "Lufttrycket utanför påsen är lägre än trycket inuti påsen.", // Rätt (Index 3)
                   ],
                   correct: 3,
                   explanation: "På hög höjd är luftpelaren ovanför oss mindre, vilket ger ett <strong>lägre lufttryck</strong>. Eftersom trycket inuti den förseglade påsen är detsamma som vid havsnivå, kommer övertrycket inuti att pressa ut påsens väggar."
               },
               {
                   q: "Varför sjunker man ner mindre i djup snö om man använder snöskor istället för vanliga stövlar?",
                   options: [
                       "Din tyngd fördelas över en större yta, vilket minskar trycket mot snön.", // Rätt (Index 0)
                       "Snöskorna ökar friktionen mot snön så att man glider ovanpå.",
                       "Snöskorna är gjorda av ett material med lägre densitet än snö.",
                       "Den totala massan minskar eftersom snöskorna är ihåliga."
                   ],
                   correct: 0,
                   explanation: "Tryck är kraft delat med area ($P = F/A$). Genom att använda snöskor ökar du arean mot snön markant. Eftersom din tyngd är oförändrad men ytan större, blir <strong>trycket per kvadratcentimeter lägre</strong> och snön håller bättre."
               },
               {
                   q: "Hur rör sig vindarna naturligt för att jämna ut skillnader i atmosfären?",
                   options: [
                       "Från lågtryck mot högtryck eftersom värme stiger.",
                       "Från högtryck mot lågtryck för att jämna ut skillnaden i lufttäthet.", // Rätt (Index 1)
                       "Vindar rör sig alltid parallellt med ekvatorn oavsett tryck.",
                       "Från kalla hav in mot varmare landområden oavsett tryck."
                   ],
                   correct: 1,
                   explanation: "Naturen strävar alltid efter jämvikt. Luft strömmar därför från områden med överskott av luft (<strong>högtryck</strong>) till områden med underskott av luft (<strong>lågtryck</strong>). Det är denna luftrörelse vi upplever som vind."
               }
           ]
       },
       {
           title: "Tema 5: Värmespridning",
           icon: "☀️",
           text: "Värme kan spridas på tre sätt: <strong>ledning</strong>, <strong>strömning</strong> och <strong>strålning</strong>. Ledning sker främst i fasta material (metaller leder bäst), strömning sker i vätskor och gaser, och strålning är ljuspartiklar (<strong>fotoner</strong>). Mörka ytor <strong>absorberar</strong> (tar upp) mer strålningsvärme än ljusa ytor, som istället <strong>reflekterar</strong> bort den.",
           questions: [
               {
                   q: "Varför bränner man sig ofta mer på tomaten än på brödet i en varm smörgås, trots samma ugnstemperatur?",
                   options: [
                       "Brödets skrovliga yta reflekterar bort värmen snabbare.",
                       "Tomaten innehåller syror som reagerar kemiskt med huden.",
                       "Tomaten innehåller mycket vatten som lagrar värmeenergi bra och leder den till huden.", // Rätt (Index 2)
                       "Brödet isolerar värmen i sin kärna och känns därför kallt på ytan."
                   ],
                   correct: 2,
                   explanation: "Vatten har en mycket hög <strong>värmekapacitet</strong>, vilket betyder att det lagrar mycket energi. Dessutom leder vatten värme bättre än det luftiga brödet. När du biter i tomaten överförs därför en stor mängd energi snabbt till din mun."
               },
               {
                   q: "Solen värmer jorden trots att rymden är ett vakuum. Hur färdas värmen hit?",
                   options: [
                       "Genom värmestrålning, som inte kräver något material att färdas i.", // Rätt (Index 0)
                       "Genom ledning via de tunna gasmoln som finns i rymden.",
                       "Genom konvektion, då solvinden kastar heta partiklar mot oss.",
                       "Genom induktion, där solens magnetfält sätter fart på jordens atomer."
                   ],
                   correct: 0,
                   explanation: "Både ledning och strömning kräver materia (atomer) för att fungera. Eftersom rymden är nästan tom kan värmen bara nå oss via <strong>elektromagnetisk strålning</strong> (infrarött ljus och synligt ljus), som kan färdas genom vakuum."
               },
               {
                   q: "Varför är det smartare att ha en vit tröja än en svart tröja om man vill hålla sig sval en solig dag?",
                   options: [
                       "Svarta kläder är tätare och stänger in kroppsvärmen mer effektivt.",
                       "Vita textilier har bättre värmeledningsförmåga och kyler huden.",
                       "Svarta ytor omvandlar solljuset till elektricitet som värmer tyget.",
                       "Vita ytor reflekterar bort solens strålningsenergi istället för att absorbera den.", // Rätt (Index 3)
                   ],
                   correct: 3,
                   explanation: "Färger som vi uppfattar som mörka <strong>absorberar</strong> (suger åt sig) det mesta av ljuset som träffar dem och omvandlar det till värme. Vita ytor <strong>reflekterar</strong> (studsar bort) ljuset, och därmed även värmeenergin."
               },
               {
                   q: "I en termostat används ofta en bimetall. Vad är principen bakom en sådan?",
                   options: [
                       "Den ena metallen blir magnetisk vid värme och slår ifrån brytaren.",
                       "Två metaller som utvidgar sig olika mycket vid värme sitter ihop, vilket får remsan att böjas.", // Rätt (Index 1)
                       "Metallen ändrar elektriskt motstånd så att strömmen stryps vid hetta.",
                       "Den kemiska bindningen mellan metallerna bryts vid en viss temperatur."
                   ],
                   correct: 1,
                   explanation: "En bimetall består av två sammanpressade metallremsor av olika material. Eftersom olika metaller har olika stor <strong>längdutvidgning</strong> vid uppvärmning, kommer den ena sidan bli längre än den andra, vilket tvingar hela remsan att <strong>böja sig</strong>."
               }
           ]
       }
   ];


   // --- STATE MANAGEMENT ---
   let currentSectionIndex = 0;
   let currentQuestionIndex = 0; // Relative to current section
   let score = 0;
   let userAnswers = [];
   let state = 'intro'; // 'intro', 'question', 'summary'


   // --- DOM ELEMENTS ---
   const app = document.getElementById('app');
   const headerTitle = document.getElementById('header-title');
   const progressBar = document.getElementById('progress-bar');


   // --- MAIN RENDER FUNCTION ---
   function render() {
       if (state === 'summary') {
           renderSummary();
           return;
       }


       const section = quizData[currentSectionIndex];


       // Update Header with smooth fade
       headerTitle.style.opacity = '0';
       setTimeout(() => {
           headerTitle.innerText = section.title;
           headerTitle.style.transition = 'opacity 0.2s';
           headerTitle.style.opacity = '1';
       }, 150);


       // Calculate total progress
       let totalQuestions = 0;
       let answeredQuestions = 0;
      
       quizData.forEach((sec, idx) => {
           totalQuestions += sec.questions.length;
           if (idx < currentSectionIndex) {
               answeredQuestions += sec.questions.length;
           } else if (idx === currentSectionIndex && state === 'question') {
               answeredQuestions += currentQuestionIndex;
           }
       });
       const pct = (answeredQuestions / totalQuestions) * 100;
       progressBar.style.width = `${pct}%`;


       if (state === 'intro') {
           renderSectionIntro(section);
       } else if (state === 'question') {
           renderQuestion(section.questions[currentQuestionIndex]);
       }
   }


   // --- RENDER SECTION TEXT ---
   function renderSectionIntro(section) {
       // Simple animation class reset
       app.classList.remove('fade-in');
       void app.offsetWidth; // trigger reflow
       app.classList.add('fade-in');


       app.innerHTML = `
           <div class="fact-box">
               <span class="fact-icon">${section.icon}</span>
               <div class="fact-content">
                   <h2>Fakta</h2>
                   <p style="line-height: 1.6; font-size: 1rem; margin-top:0;">${section.text}</p>
               </div>
           </div>
           <button class="btn" onclick="startQuestions()">Starta frågor för denna del</button>
       `;
   }


   // --- RENDER QUESTION ---
   function renderQuestion(q) {
       const totalInCurrent = quizData[currentSectionIndex].questions.length;
      
       // Render with reset styles for feedback box
       app.innerHTML = `
           <div class="question-meta">Del ${currentSectionIndex + 1} • Fråga ${currentQuestionIndex + 1}/${totalInCurrent}</div>
           <h2 style="color: #2c3e50; font-weight: 600; margin-bottom:15px;">${q.q}</h2>
           <div class="options-grid">
               ${q.options.map((opt, idx) => `
                   <button class="option-btn" onclick="handleAnswer(${idx})" id="opt-${idx}">${opt}</button>
               `).join('')}
           </div>
           <div id="feedback" class="feedback-box">
               <h3 id="feedback-title"></h3>
               <p id="feedback-text" style="margin: 5px 0 15px 0; font-size: 0.95rem; line-height: 1.6;"></p>
               <button class="btn" id="next-btn" onclick="nextStep()" style="margin-top:0; width: auto; min-width: 150px;">Nästa fråga ➔</button>
           </div>
       `;
   }


   // --- RENDER SUMMARY ---
   function renderSummary() {
       headerTitle.innerText = "Sammanfattning";
       progressBar.style.width = '100%';
      
       let totalQ = 0;
       quizData.forEach(s => totalQ += s.questions.length);
      
       // Calculate score
       let correctCount = userAnswers.filter(a => a.isCorrect).length;
       let pct = Math.round((correctCount / totalQ) * 100);
      
       let gradeTitle = "";
      
       if(pct > 90) { gradeTitle = "Fantastiskt bra! 🏆"; }
       else if(pct > 70) { gradeTitle = "Mycket bra jobbat! 🌟"; }
       else if(pct > 50) { gradeTitle = "Godkänt! 👍"; }
       else { gradeTitle = "Fortsätt kämpa! 💪"; }


       let html = `
           <div class="summary-stats">
               <h2 style="color:var(--brand-color); margin:0 0 10px 0;">${gradeTitle}</h2>
               <span class="summary-score">${correctCount}/${totalQ}</span>
               <span style="color:#666; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">Rätt svar</span>
               <button class="btn" onclick="location.reload()" style="background: transparent; border: 2px solid var(--accent-color); color: var(--accent-color); margin-top: 20px; box-shadow:none; width: auto; padding: 10px 30px;">Gör om testet</button>
           </div>
           <h3 style="margin: 0 0 10px 0; font-size: 1.1rem; color: var(--text-muted);">Dina svar:</h3>
           <div class="summary-list">
       `;


       userAnswers.forEach((ans, idx) => {
           const isCorrect = ans.isCorrect;
          
           html += `
               <div class="summary-item">
                   <span class="summary-question">${idx + 1}. ${ans.question}</span>
                   <div class="summary-answer-row">
                       ${isCorrect
                           ? `<span class="summary-correct-text">✔ ${ans.userAnswer}</span>`
                           : `<span class="summary-wrong-text">✖ ${ans.userAnswer}</span> <span style="margin: 0 5px; color:#999;">➔</span> <span class="real-answer">${ans.correctAnswer}</span>`
                       }
                   </div>
               </div>
           `;
       });


       html += `</div>`;
       app.innerHTML = html;
   }


   // --- LOGIC FUNCTIONS ---
   window.startQuestions = function() {
       state = 'question';
       currentQuestionIndex = 0;
       render();
   };


   window.handleAnswer = function(selectedIndex) {
       // Disable all buttons
       const buttons = document.querySelectorAll('.option-btn');
       buttons.forEach(b => b.disabled = true);


       const section = quizData[currentSectionIndex];
       const currentQ = section.questions[currentQuestionIndex];
       const isCorrect = selectedIndex === currentQ.correct;


       // Visual feedback on buttons
       const selectedBtn = document.getElementById(`opt-${selectedIndex}`);
       const correctBtn = document.getElementById(`opt-${currentQ.correct}`);


       if (isCorrect) {
           selectedBtn.classList.add('correct');
       } else {
           selectedBtn.classList.add('incorrect');
           correctBtn.classList.add('correct'); // Show which one was right
       }


       // Show feedback box
       const feedbackBox = document.getElementById('feedback');
       const feedbackTitle = document.getElementById('feedback-title');
       const feedbackText = document.getElementById('feedback-text');
       const nextBtn = document.getElementById('next-btn');


       feedbackBox.style.display = 'block';
      
       // Add class for success/error styling
       if (isCorrect) {
           feedbackBox.className = "feedback-box success";
           feedbackTitle.innerHTML = "Rätt svar!";
       } else {
           feedbackBox.className = "feedback-box error";
           feedbackTitle.innerHTML = "Inte riktigt...";
       }
      
       feedbackText.innerHTML = currentQ.explanation; // Use innerHTML to render <strong> tags


       // Check if last question of entire quiz
       const isLastQuestionOverall = (currentSectionIndex === quizData.length - 1) && (currentQuestionIndex === section.questions.length - 1);
      
       if(isLastQuestionOverall) {
           nextBtn.innerText = "Se resultat 🏁";
       } else if (currentQuestionIndex === section.questions.length - 1) {
           nextBtn.innerText = "Nästa del ➔";
       }


       // Scroll to feedback if needed on mobile, but gently
       const rect = feedbackBox.getBoundingClientRect();
       const isVisible = (rect.top >= 0) && (rect.bottom <= window.innerHeight);
       if (!isVisible) {
           setTimeout(() => {
               feedbackBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
           }, 100);
       }


       // Save data
       userAnswers.push({
           question: currentQ.q,
           userAnswer: currentQ.options[selectedIndex],
           correctAnswer: currentQ.options[currentQ.correct],
           isCorrect: isCorrect
       });
   };


   window.nextStep = function() {
       const section = quizData[currentSectionIndex];
      
       // Reset feedback styles for next render
       const feedbackBox = document.getElementById('feedback');
       if(feedbackBox) {
           feedbackBox.style.display = 'none';
       }


       // Check if there are more questions in this section
       if (currentQuestionIndex < section.questions.length - 1) {
           currentQuestionIndex++;
           render();
       } else {
           // End of section, move to next section
           if (currentSectionIndex < quizData.length - 1) {
               currentSectionIndex++;
               state = 'intro';
               render();
           } else {
               // End of quiz
               state = 'summary';
               render();
           }
       }
   };


   // --- INIT ---
   render();


</script>


</body>
</html>