<!DOCTYPE html>
<html lang="sv">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Fysikquiz: Energi & Teknik (Åk 9)</title>
   <!-- Importerar moderna fonter från Google Fonts -->
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Poppins:wght@500;700&display=swap" rel="stylesheet">
  
   <style>
       :root {
           /* Färgpalett - Professionell & Ren */
           --card-bg: #ffffff;
          
           --brand-color: #2c3e50;
           --brand-gradient: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
          
           --accent-color: #3498db;
          
           --success-color: #10ac84;
           --success-bg: #e3f9f1;
          
           --error-color: #ee5253;
           --error-bg: #ffeded;
          
           --text-main: #2d3436;
           --text-muted: #636e72;
          
           --shadow-card: 0 10px 25px rgba(0,0,0,0.15); /* Lite starkare skugga för kontrast mot mörk bakgrund */
           --shadow-hover: 0 6px 16px rgba(0,0,0,0.12);
           --radius-main: 16px;
       }


       body {
           font-family: 'Open Sans', sans-serif;
           /* Ny bakgrund: En gråaktig fade (Silver/Metallic style) */
           background-image: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
           color: var(--text-main);
           margin: 0;
           padding: 15px;
           display: flex;
           justify-content: center;
           align-items: flex-start;
           min-height: 100vh;
       }


       .container {
           background-color: var(--card-bg);
           width: 100%;
           max-width: 680px;
           border-radius: var(--radius-main);
           box-shadow: var(--shadow-card);
           overflow: hidden;
           display: flex;
           flex-direction: column;
           position: relative;
           margin-top: 3vh;
           margin-bottom: 3vh;
       }


       header {
           background: var(--brand-gradient);
           color: white;
           padding: 20px;
           text-align: center;
           position: relative;
           overflow: hidden;
       }


       h1 {
           font-family: 'Poppins', sans-serif;
           margin: 0;
           font-size: 1.5rem;
           font-weight: 700;
           letter-spacing: -0.3px;
       }


       .content-area {
           padding: 25px 30px;
           flex-grow: 1;
       }


       h2 {
           font-family: 'Poppins', sans-serif;
           color: var(--brand-color);
           margin-top: 0;
           font-size: 1.3rem;
           margin-bottom: 0.8rem;
           line-height: 1.3;
       }


       /* Fact Section Styles */
       .fact-box {
           background: #f8f9fa;
           border-radius: 12px;
           padding: 20px;
           margin-bottom: 20px;
           border-left: 4px solid var(--accent-color);
           display: flex;
           gap: 15px;
           align-items: flex-start;
       }
      
       .fact-icon {
           font-size: 2rem;
           display: block;
           margin-top: -5px;
       }
      
       .fact-content {
           flex: 1;
       }


       .btn {
           background: var(--brand-gradient);
           color: white;
           border: none;
           padding: 12px 24px;
           font-family: 'Poppins', sans-serif;
           font-size: 1rem;
           font-weight: 600;
           border-radius: 8px;
           cursor: pointer;
           transition: all 0.2s ease;
           display: block;
           width: 100%;
           margin-top: 20px;
           box-shadow: 0 4px 10px rgba(52, 152, 219, 0.2);
       }


       .btn:hover {
           transform: translateY(-2px);
           box-shadow: 0 6px 14px rgba(52, 152, 219, 0.3);
           opacity: 0.95;
       }


       /* Question Styles */
       .question-meta {
           display: inline-block;
           color: var(--text-muted);
           font-size: 0.85rem;
           margin-bottom: 10px;
           font-weight: 600;
           text-transform: uppercase;
           letter-spacing: 0.5px;
       }


       .options-grid {
           display: grid;
           gap: 12px;
           margin-top: 20px;
       }


       .option-btn {
           background-color: #fff;
           border: 2px solid #f1f2f6;
           padding: 15px 20px;
           text-align: left;
           border-radius: 10px;
           cursor: pointer;
           font-family: 'Open Sans', sans-serif;
           font-size: 0.95rem;
           font-weight: 500;
           transition: all 0.15s ease;
           color: var(--text-main);
           position: relative;
       }


       .option-btn:hover:not(:disabled) {
           border-color: var(--accent-color);
           background-color: #f8fcff;
           transform: translateX(3px);
           box-shadow: 0 2px 5px rgba(0,0,0,0.05);
       }
      
       /* Status states for options */
       .option-btn.correct {
           background-color: var(--success-bg);
           border-color: var(--success-color);
           color: #0b6e4f;
           font-weight: 600;
       }
      
       .option-btn.correct::after {
           content: "✓";
           position: absolute;
           right: 15px;
           font-weight: bold;
       }


       .option-btn.incorrect {
           background-color: var(--error-bg);
           border-color: var(--error-color);
           color: #c0392b;
           opacity: 0.8;
       }


       .option-btn:disabled {
           cursor: default;
       }


       /* Feedback Box */
       .feedback-box {
           margin-top: 20px;
           padding: 20px 25px;
           border-radius: 12px;
           background-color: #f8f9fa; /* Ljus bakgrund igen */
           color: var(--text-main); /* Mörk text */
           border: 1px solid #e9ecef; /* Subtil ram istället för färgad kant */
           display: none;
           animation: fadeIn 0.3s ease;
       }
      
       .feedback-box h3 {
           margin-top: 0;
           font-family: 'Poppins', sans-serif;
           font-size: 1.2rem;
           display: flex;
           align-items: center;
           gap: 8px;
           margin-bottom: 8px;
       }


       .feedback-box.success h3 {
           color: var(--success-color);
       }
      
       .feedback-box.error h3 {
           color: var(--error-color);
       }


       .feedback-box strong {
           color: var(--brand-color);
       }


       @keyframes fadeIn {
           from { opacity: 0; transform: translateY(5px); }
           to { opacity: 1; transform: translateY(0); }
       }


       /* Progress Bar Styles */
       .progress-bar-container {
           height: 6px;
           background-color: #f1f3f5;
           width: 100%;
           position: relative;
           z-index: 10;
       }


       .progress-bar {
           height: 100%;
           background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
           width: 0%;
           transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
           border-radius: 0 4px 4px 0;
           box-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
       }


       /* Summary Styles */
       .summary-stats {
           text-align: center;
           background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
           border: 1px solid #dee2e6;
           padding: 30px 20px;
           border-radius: 12px;
           margin-bottom: 20px;
       }


       .summary-score {
           font-size: 3.5rem;
           font-family: 'Poppins', sans-serif;
           font-weight: 700;
           display: block;
           margin: 5px 0;
           line-height: 1;
           background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
           -webkit-background-clip: text;
           -webkit-text-fill-color: transparent;
       }
      
       .summary-list {
           max-height: 400px;
           overflow-y: auto;
           padding-right: 10px;
       }
      
       .summary-item {
           background: white;
           border-bottom: 1px solid #f1f1f1;
           padding: 12px 0;
       }
      
       .summary-item:last-child {
           border-bottom: none;
       }


       .summary-question {
           font-weight: 600;
           margin-bottom: 4px;
           display: block;
           font-size: 0.95rem;
       }
      
       .summary-answer-row {
           font-size: 0.9rem;
       }


       .summary-correct-text { color: var(--success-color); font-weight: 600; }
       .summary-wrong-text { color: var(--error-color); text-decoration: line-through; opacity: 0.8;}
       .real-answer { color: var(--success-color); font-weight: 600; margin-left: 5px; }


       /* Helpers */
       strong {
           color: var(--brand-color);
           font-weight: 700;
       }


   </style>
</head>
<body>


<div class="container">
   <header>
       <h1 id="header-title">Fysikquiz Åk 9</h1>
   </header>
   <div class="progress-bar-container">
       <div class="progress-bar" id="progress-bar"></div>
   </div>


   <div class="content-area" id="app">
       <!-- Content will be injected here by JavaScript -->
   </div>
</div>


<script>
   // --- DATA ---
   const quizData = [
       {
           title: "Del 1: Vad är energi?",
           icon: "⚡",
           text: "Energi är det som får saker att hända och finns i allt som rör sig, lever, lyser eller är varmt. En av fysikens viktigaste regler är <strong>energiprincipen</strong>, som säger att energi aldrig kan förstöras eller skapas, utan bara <strong>omvandlas</strong> från en form till en annan. Vetenskapen delar in energi i olika energiformer beroende på hur den visar sig, till exempel <strong>rörelseenergi</strong>, <strong>värmeenergi</strong> och <strong>kemisk energi</strong>.",
           questions: [
               {
                   q: "Vad innebär egentligen energiprincipen?",
                   options: [
                       "Energi är en kraft som långsamt förbrukas när arbete utförs.",
                       "Energi är konstant men tappar i styrka varje gång den används.",
                       "Energi kan inte skapas eller förstöras, bara omvandlas.", // Rätt (Index 2)
                       "Energi skapas i kraftverk och förstörs i våra apparater."
                   ],
                   correct: 2,
                   explanation: "Enligt <strong>energiprincipen</strong> är mängden energi i universum konstant. Energi kan varken skapas ur tomma intet eller försvinna helt, utan den <strong>omvandlas</strong> ständigt mellan olika former som lägesenergi, rörelseenergi och värme."
               },
               {
                   q: "I vilket av följande alternativ finns lagrad kemisk energi?",
                   options: [
                       "I mat, bensin och batterier.", // Rätt (Index 0)
                       "I en hoptryckt fjäder eller ett spänt gummiband.",
                       "I föremål som nyligen har värmts upp kraftigt.",
                       "I fordon som rör sig snabbt framåt på vägen."
                   ],
                   correct: 0,
                   explanation: "<strong>Kemisk energi</strong> finns lagrad i atomernas bindningar i olika ämnen. När vi äter mat eller förbränner bensin bryts dessa bindningar, och energin frigörs för att kunna användas till rörelse eller värme."
               },
               {
                   q: "Vad menas med begreppet mekanisk energi?",
                   options: [
                       "Det är ett annat ord för elektrisk energi som driver motorer.",
                       "Det är energin som frigörs vid friktion mellan ytor.",
                       "Det är enbart den energi som krävs för att starta en rörelse.",
                       "Det är ett samlingsnamn för lägesenergi och rörelseenergi." // Rätt (Index 3)
                   ],
                   correct: 3,
                   explanation: "<strong>Mekanisk energi</strong> är ett samlingsbegrepp som innefattar både ett föremåls <strong>rörelseenergi</strong> (kinetisk energi) och dess <strong>lägesenergi</strong> (potentiell energi). Det beskriver alltså den totala energin kopplad till ett föremåls position och rörelse."
               }
           ]
       },
       {
           title: "Del 2: Energiövergångar",
           icon: "🔄",
           text: "När energi byter form kallas det för en <strong>energiövergång</strong>. I en bilmotor omvandlas bränslets <strong>kemiska energi</strong> till rörelse, men en stor del blir också till <strong>värme</strong>. I en gunga sker en ständig växling: när du är högst upp har du som mest <strong>lägesenergi</strong>, och när du är längst ner i mitten har du som mest <strong>rörelseenergi</strong>.",
           questions: [
               {
                   q: "Vad händer med huvuddelen av energin i bränslet i en vanlig bilmotor?",
                   options: [
                       "Den omvandlas till ren rörelseenergi med nästan 100% effektivitet.",
                       "Den omvandlas till värmeenergi istället för att driva bilen framåt.", // Rätt (Index 1)
                       "Den lagras i bilens batteri för att användas vid start.",
                       "Den försvinner spårlöst eftersom den förbrukas av motorn."
                   ],
                   correct: 1,
                   explanation: "I en förbränningsmotor är <strong>verkningsgraden</strong> sällan högre än 30-40%, vilket innebär att huvuddelen av energin i bränslet blir till spillvärme. Denna <strong>värmeenergi</strong> måste kylas bort för att motorn inte ska överhettas."
               },
               {
                   q: "När är rörelseenergin som allra störst för en person som gungar?",
                   options: [
                       "I vändlägena högst upp där gungan stannar till.",
                       "Rörelseenergin är konstant under hela gungandet.",
                       "Precis i mitten av rörelsen, vid den lägsta punkten.", // Rätt (Index 2)
                       "När man hoppar av gungan i dess högsta punkt."
                   ],
                   correct: 2,
                   explanation: "När gungan är i sin lägsta punkt har all <strong>lägesenergi</strong> från höjden omvandlats till <strong>rörelseenergi</strong>, vilket ger högst fart. I vändlägena högst upp är farten noll och energin är återigen bunden som lägesenergi."
               }
           ]
       },
       {
           title: "Del 3: Elproduktion",
           icon: "🏭",
           text: "För att producera elektricitet i stor skala används en <strong>generator</strong>. Den fungerar genom <strong>induktion</strong>, vilket innebär att en magnet snurrar inuti eller nära en spole av koppartråd. När magnetfältet förändras inuti spolen skapas en elektrisk ström. Denna upptäckt har haft enorm betydelse för våra levnadsvillkor.",
           questions: [
               {
                   q: "Vilka två komponenter är avgörande i en generator för att skapa ström?",
                   options: [
                       "En stark magnet och en spole (ledare).", // Rätt (Index 0)
                       "En solcell och en elektrisk motor.",
                       "En kondensator och ett laddningsbart batteri.",
                       "En transformator och en strömbrytare."
                   ],
                   correct: 0,
                   explanation: "En generator skapar ström genom <strong>induktion</strong>, vilket sker när en <strong>magnet</strong> rör sig i förhållande till en <strong>spole</strong>. Det föränderliga magnetfältet sätter fart på elektronerna i ledningen och skapar en elektrisk ström."
               },
               {
                   q: "Hur påverkade upptäckten av generatorn samhället i stort?",
                   options: [
                       "Den gjorde att vi slutade använda kol och olja helt och hållet.",
                       "Den uppfanns enbart för att ersätta farliga kärnkraftverk.",
                       "Den används mest för att värma upp vatten i enskilda hushåll.",
                       "Den möjliggjorde massproduktion av el till industrier och hem." // Rätt (Index 3)
                   ],
                   correct: 3,
                   explanation: "Upptäckten av generatorn var startskottet för det moderna samhället eftersom den möjliggjorde <strong>masstillverkning av elektricitet</strong>. Detta gav oss elektriskt ljus, drivkraft till industrier och förändrade våra levnadsvillkor i grunden."
               }
           ]
       },
       {
           title: "Del 4: Energikällor & Miljö",
           icon: "🌍",
           text: "Energikällor delas in i <strong>förnybara</strong> (som vind och vatten) och <strong>icke-förnybara</strong> (som kol och olja). Förbränning av fossila bränslen ökar halten av <strong>koldioxid</strong> i atmosfären, vilket förstärker <strong>växthuseffekten</strong> och leder till global uppvärmning. <strong>Kärnkraft</strong> är en icke-förnybar källa som inte släpper ut koldioxid, men den skapar radioaktivt avfall.",
           questions: [
               {
                   q: "Vilken av följande energikällor räknas som förnybar?",
                   options: [
                       "Naturgas, eftersom den bildas naturligt i marken.",
                       "Vindkraft, eftersom vinden ständigt fylls på.", // Rätt (Index 1)
                       "Kärnkraft, eftersom uran räcker i tusentals år.",
                       "Oljekraft, eftersom olja ursprungligen kommer från växter."
                   ],
                   correct: 1,
                   explanation: "<strong>Vindkraft</strong> räknas som en förnybar energikälla eftersom vinden ständigt fylls på så länge solen lyser. Till skillnad från fossila bränslen tar den inte slut inom en överskådlig framtid."
               },
               {
                   q: "Vad är en betydande miljömässig nackdel med vattenkraft?",
                   options: [
                       "Den producerar stora mängder radioaktivt avfall.",
                       "Den släpper ut mycket koldioxid vid själva driften.",
                       "Den påverkar ekosystem och hindrar fiskars vandringsvägar.", // Rätt (Index 2)
                       "Den fungerar bara soliga dagar då snön smälter."
                   ],
                   correct: 2,
                   explanation: "Även om vattenkraft är utsläppsfri, innebär dammbyggen stora ingrepp i naturen som förändrar <strong>ekosystemen</strong>. Detta påverkar den biologiska mångfalden, exempelvis genom att hindra lax och öring från att vandra uppströms för att leka."
               },
               {
                   q: "Vilken är den största globala risken med att använda fossila bränslen?",
                   options: [
                       "De orsakar hål i ozonlagret genom utsläpp av freoner.", // Rätt (Index 0)
                       "De kyler ner atmosfären genom att blockera solljuset.",
                       "De är radioaktiva och avfallet måste slutförvaras.",
                       "De ökar halten koldioxid och förstärker växthuseffekten."
                   ],
                   correct: 3, // Wait, I put Correct at index 0 in my plan, but the text is Ozone hole (wrong).
                   // Correction: Keep the correct answer text ("De ökar halten...") but check the index.
                   // Correct answer is "De ökar halten koldioxid...". I will put it at index 0 in the file to follow the plan.
                   // Let's re-arrange this question block in the code below to match my plan (4.3 -> Index 0).
               }
           ]
       },
       {
           title: "Del 5: Klimatet",
           icon: "🌡️",
           text: "<strong>Växthuseffekten</strong> är naturlig och nödvändig för livet på jorden, men människan har förstärkt den. Atmosfären fungerar som ett skyddande lager som släpper in solens strålning men hindrar en del av <strong>värmestrålningen</strong> från att lämna jorden. När vi ökar mängden <strong>växthusgaser</strong> hålls mer värme kvar.",
           questions: [
               {
                   q: "Hur fungerar växthusgaser i atmosfären?",
                   options: [
                       "De reflekterar bort solljuset innan det når jordytan.",
                       "De omvandlar solljus till elektricitet i övre atmosfären.",
                       "De bryter ner ozonlagret så att värmen läcker in.",
                       "De absorberar värmestrålning från jorden och håller kvar värmen." // Rätt (Index 3)
                   ],
                   correct: 3,
                   explanation: "Växthusgaser som koldioxid och metan släpper igenom solljus men absorberar den <strong>värmestrålning</strong> som jorden sänder ut. Detta fungerar som en filt som håller kvar värmen, vilket kallas för <strong>växthuseffekten</strong>."
               },
               {
                   q: "Vilken typ av strålning skyddar ozonlagret oss främst emot?",
                   options: [
                       "Infraröd strålning, som värmer upp jorden för mycket.",
                       "Ultraviolett strålning (UV), som kan skada DNA.", // Rätt (Index 1)
                       "Mikrovågsstrålning, som påverkar vattenmolekyler i kroppen.",
                       "Gammastrålning, som strålar ut från jordens inre kärna."
                   ],
                   correct: 1,
                   explanation: "Ozonlagret fungerar som ett skydd mot solens skadliga <strong>UV-strålning</strong>. Utan detta skydd skulle mer strålning nå jordytan, vilket ökar risken för hudcancer och kan skada växter och djur."
               }
           ]
       },
       {
           title: "Del 6: Elnätet",
           icon: "🔌",
           text: "Elektricitet produceras i kraftverk och transporteras till hemmen via ett elnät. I stamnätet används <strong>högspänning</strong> för att undvika att elenergin omvandlas till <strong>värme</strong> i ledningarna (energiförluster). Innan strömmen når ditt vägguttag måste spänningen sänkas i en <strong>transformator</strong>.",
           questions: [
               {
                   q: "Varför används högspänning i de långa ledningarna från kraftverken?",
                   options: [
                       "För att elektriciteten ska nå fram till hushållen snabbare.",
                       "För att skydda ledningarna mot blixtnedslag och stormar.",
                       "För att minska energiförlusterna i ledningarna.", // Rätt (Index 2)
                       "För att våra apparater kräver extremt hög spänning för att starta."
                   ],
                   correct: 2,
                   explanation: "Genom att transportera el med <strong>hög spänning</strong> kan man sänka strömstyrkan. Detta är viktigt eftersom hög strömstyrka leder till att ledningarna blir varma, vilket skulle innebära stora <strong>energiförluster</strong> på vägen."
               },
               {
                   q: "Vad är transformatorns huvuduppgift i elnätet?",
                   options: [
                       "Den höjer eller sänker spänningen till önskad nivå.", // Rätt (Index 0)
                       "Den omvandlar växelström till likström för batterier.",
                       "Den genererar ny elektricitet vid hög belastning.",
                       "Den mäter hur mycket el som förbrukas i varje område."
                   ],
                   correct: 0,
                   explanation: "En <strong>transformator</strong> används för att ändra spänningen i elnätet. Den sänker den höga spänningen från stamnätet till en lägre nivå (230 V) som är säker att använda i våra <strong>vägguttag</strong> hemma."
               }
           ]
       },
       {
           title: "Del 7: Teknik i vardagen",
           icon: "📱",
           text: "Fysik används i många tekniska lösningar. <strong>Solceller</strong> tillverkas ofta av kisel och skapar ström direkt när de belyses av solen. Inom sjukvården används <strong>ultraljud</strong> (ljud med mycket hög frekvens) för att undersöka organ eller foster utan att skada dem.",
           questions: [
               {
                   q: "Vilken energiform omvandlas till elektricitet i en solcell?",
                   options: [
                       "Värmeenergi från solens heta strålar.",
                       "Kemisk energi från luften runt panelen.",
                       "Mekanisk energi från vindens rörelser.",
                       "Strålningsenergi (ljus) från solen." // Rätt (Index 3)
                   ],
                   correct: 3,
                   explanation: "Solceller består av halvledarmaterial som direkt omvandlar solens <strong>strålningsenergi</strong> (fotoner) till elektrisk ström. Det är alltså ljuset, inte värmen, som driver processen."
               },
               {
                   q: "Vad kännetecknar ultraljud?",
                   options: [
                       "Ljud som färdas snabbare än ljuset i vakuum.",
                       "Ljudvågor med så hög frekvens att människor inte kan höra dem.", // Rätt (Index 1)
                       "Ljudvågor med extremt låg frekvens som färdas långt.",
                       "Ljud som används för att krossa njursten men hörs som ett pip."
                   ],
                   correct: 1,
                   explanation: "<strong>Ultraljud</strong> är ljudvågor med en frekvens över 20 000 Hz, vilket är gränsen för vad det mänskliga örat kan uppfatta. Det används ofta inom sjukvården för att skapa bilder av kroppens inre, till exempel vid graviditet."
               }
           ]
       }
   ];


   // Correction for 4.3 logic within code to ensure Index 0 is correct
   // (Re-writing the specific object for 4.3 correctly in the final output)
   quizData[3].questions[2] = {
       q: "Vilken är den största globala risken med att använda fossila bränslen?",
       options: [
           "De ökar halten koldioxid och förstärker växthuseffekten.", // Correct
           "De orsakar hål i ozonlagret genom utsläpp av freoner.",
           "De kyler ner atmosfären genom att blockera solljuset.",
           "De är radioaktiva och avfallet måste slutförvaras."
       ],
       correct: 0,
       explanation: "När vi förbränner kol och olja frigörs kol som varit bundet i marken i miljontals år som <strong>koldioxid</strong>. Detta ökar mängden växthusgaser i atmosfären, vilket stänger inne mer värme och leder till <strong>global uppvärmning</strong>."
   };




   // --- STATE MANAGEMENT ---
   let currentSectionIndex = 0;
   let currentQuestionIndex = 0; // Relative to current section
   let score = 0;
   let userAnswers = [];
   let state = 'intro'; // 'intro', 'question', 'summary'


   // --- DOM ELEMENTS ---
   const app = document.getElementById('app');
   const headerTitle = document.getElementById('header-title');
   const progressBar = document.getElementById('progress-bar');


   // --- MAIN RENDER FUNCTION ---
   function render() {
       if (state === 'summary') {
           renderSummary();
           return;
       }


       const section = quizData[currentSectionIndex];


       // Update Header with smooth fade
       headerTitle.style.opacity = '0';
       setTimeout(() => {
           headerTitle.innerText = section.title;
           headerTitle.style.transition = 'opacity 0.2s';
           headerTitle.style.opacity = '1';
       }, 150);


       // Calculate total progress
       let totalQuestions = 0;
       let answeredQuestions = 0;
      
       quizData.forEach((sec, idx) => {
           totalQuestions += sec.questions.length;
           if (idx < currentSectionIndex) {
               answeredQuestions += sec.questions.length;
           } else if (idx === currentSectionIndex && state === 'question') {
               answeredQuestions += currentQuestionIndex;
           }
       });
       const pct = (answeredQuestions / totalQuestions) * 100;
       progressBar.style.width = `${pct}%`;


       if (state === 'intro') {
           renderSectionIntro(section);
       } else if (state === 'question') {
           renderQuestion(section.questions[currentQuestionIndex]);
       }
   }


   // --- RENDER SECTION TEXT ---
   function renderSectionIntro(section) {
       // Simple animation class reset
       app.classList.remove('fade-in');
       void app.offsetWidth; // trigger reflow
       app.classList.add('fade-in');


       app.innerHTML = `
           <div class="fact-box">
               <span class="fact-icon">${section.icon}</span>
               <div class="fact-content">
                   <h2>Fakta</h2>
                   <p style="line-height: 1.6; font-size: 1rem; margin-top:0;">${section.text}</p>
               </div>
           </div>
           <button class="btn" onclick="startQuestions()">Starta frågor för denna del</button>
       `;
   }


   // --- RENDER QUESTION ---
   function renderQuestion(q) {
       const totalInCurrent = quizData[currentSectionIndex].questions.length;
      
       // Render with reset styles for feedback box
       app.innerHTML = `
           <div class="question-meta">Del ${currentSectionIndex + 1} • Fråga ${currentQuestionIndex + 1}/${totalInCurrent}</div>
           <h2 style="color: #2c3e50; font-weight: 600; margin-bottom:15px;">${q.q}</h2>
           <div class="options-grid">
               ${q.options.map((opt, idx) => `
                   <button class="option-btn" onclick="handleAnswer(${idx})" id="opt-${idx}">${opt}</button>
               `).join('')}
           </div>
           <div id="feedback" class="feedback-box">
               <h3 id="feedback-title"></h3>
               <p id="feedback-text" style="margin: 5px 0 15px 0; font-size: 0.95rem; line-height: 1.6;"></p>
               <button class="btn" id="next-btn" onclick="nextStep()" style="margin-top:0; width: auto; min-width: 150px;">Nästa fråga ➔</button>
           </div>
       `;
   }


   // --- RENDER SUMMARY ---
   function renderSummary() {
       headerTitle.innerText = "Sammanfattning";
       progressBar.style.width = '100%';
      
       let totalQ = 0;
       quizData.forEach(s => totalQ += s.questions.length);
      
       // Calculate score
       let correctCount = userAnswers.filter(a => a.isCorrect).length;
       let pct = Math.round((correctCount / totalQ) * 100);
      
       let gradeTitle = "";
      
       if(pct > 90) { gradeTitle = "Fantastiskt bra! 🏆"; }
       else if(pct > 70) { gradeTitle = "Mycket bra jobbat! 🌟"; }
       else if(pct > 50) { gradeTitle = "Godkänt! 👍"; }
       else { gradeTitle = "Fortsätt kämpa! 💪"; }


       let html = `
           <div class="summary-stats">
               <h2 style="color:var(--brand-color); margin:0 0 10px 0;">${gradeTitle}</h2>
               <span class="summary-score">${correctCount}/${totalQ}</span>
               <span style="color:#666; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">Rätt svar</span>
               <button class="btn" onclick="location.reload()" style="background: transparent; border: 2px solid var(--accent-color); color: var(--accent-color); margin-top: 20px; box-shadow:none; width: auto; padding: 10px 30px;">Gör om testet</button>
           </div>
           <h3 style="margin: 0 0 10px 0; font-size: 1.1rem; color: var(--text-muted);">Dina svar:</h3>
           <div class="summary-list">
       `;


       userAnswers.forEach((ans, idx) => {
           const isCorrect = ans.isCorrect;
          
           html += `
               <div class="summary-item">
                   <span class="summary-question">${idx + 1}. ${ans.question}</span>
                   <div class="summary-answer-row">
                       ${isCorrect
                           ? `<span class="summary-correct-text">✔ ${ans.userAnswer}</span>`
                           : `<span class="summary-wrong-text">✖ ${ans.userAnswer}</span> <span style="margin: 0 5px; color:#999;">➔</span> <span class="real-answer">${ans.correctAnswer}</span>`
                       }
                   </div>
               </div>
           `;
       });


       html += `</div>`;
       app.innerHTML = html;
   }


   // --- LOGIC FUNCTIONS ---
   window.startQuestions = function() {
       state = 'question';
       currentQuestionIndex = 0;
       render();
   };


   window.handleAnswer = function(selectedIndex) {
       // Disable all buttons
       const buttons = document.querySelectorAll('.option-btn');
       buttons.forEach(b => b.disabled = true);


       const section = quizData[currentSectionIndex];
       const currentQ = section.questions[currentQuestionIndex];
       const isCorrect = selectedIndex === currentQ.correct;


       // Visual feedback on buttons
       const selectedBtn = document.getElementById(`opt-${selectedIndex}`);
       const correctBtn = document.getElementById(`opt-${currentQ.correct}`);


       if (isCorrect) {
           selectedBtn.classList.add('correct');
       } else {
           selectedBtn.classList.add('incorrect');
           correctBtn.classList.add('correct'); // Show which one was right
       }


       // Show feedback box
       const feedbackBox = document.getElementById('feedback');
       const feedbackTitle = document.getElementById('feedback-title');
       const feedbackText = document.getElementById('feedback-text');
       const nextBtn = document.getElementById('next-btn');


       feedbackBox.style.display = 'block';
      
       // Add class for success/error styling
       if (isCorrect) {
           feedbackBox.className = "feedback-box success";
           feedbackTitle.innerHTML = "Rätt svar!";
       } else {
           feedbackBox.className = "feedback-box error";
           feedbackTitle.innerHTML = "Inte riktigt...";
       }
      
       feedbackText.innerHTML = currentQ.explanation; // Use innerHTML to render <strong> tags


       // Check if last question of entire quiz
       const isLastQuestionOverall = (currentSectionIndex === quizData.length - 1) && (currentQuestionIndex === section.questions.length - 1);
      
       if(isLastQuestionOverall) {
           nextBtn.innerText = "Se resultat 🏁";
       } else if (currentQuestionIndex === section.questions.length - 1) {
           nextBtn.innerText = "Nästa del ➔";
       }


       // Scroll to feedback if needed on mobile, but gently
       const rect = feedbackBox.getBoundingClientRect();
       const isVisible = (rect.top >= 0) && (rect.bottom <= window.innerHeight);
       if (!isVisible) {
           setTimeout(() => {
               feedbackBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
           }, 100);
       }


       // Save data
       userAnswers.push({
           question: currentQ.q,
           userAnswer: currentQ.options[selectedIndex],
           correctAnswer: currentQ.options[currentQ.correct],
           isCorrect: isCorrect
       });
   };


   window.nextStep = function() {
       const section = quizData[currentSectionIndex];
      
       // Reset feedback styles for next render
       const feedbackBox = document.getElementById('feedback');
       if(feedbackBox) {
           feedbackBox.style.display = 'none';
       }


       // Check if there are more questions in this section
       if (currentQuestionIndex < section.questions.length - 1) {
           currentQuestionIndex++;
           render();
       } else {
           // End of section, move to next section
           if (currentSectionIndex < quizData.length - 1) {
               currentSectionIndex++;
               state = 'intro';
               render();
           } else {
               // End of quiz
               state = 'summary';
               render();
           }
       }
   };


   // --- INIT ---
   render();


</script>


</body>
</html>